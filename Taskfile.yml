version: '2'

# Go task : https://taskfile.org

vars:
  S3_BUCKET: gma-test
  STACK_NAME: aws-sam-ws-python-stack
  TEMPLATE: template.yml
  #DDB_TABLE: aws-sam-ws-python-stack-HelloTable-1DT9ELGRNJQGX
  API_URL: 'https://67ga7wr8x7.execute-api.eu-west-1.amazonaws.com/Prod/'

tasks:
  validate:
    desc: Validate Cloudformation syntax
    cmds:
      - sam validate --template {{.TEMPLATE}}

  build:
    desc: Build Cloudformation template
    deps:
      - validate
    cmds:
      - sam build --use-container --template {{.TEMPLATE}} --debug --manifest requirements.txt

  package:
    desc: transform and package cloudfomartion template to Amazon S3
    deps: []
    cmds:
      - sam package --s3-bucket {{.S3_BUCKET}} --output-template-file packaged.yaml

  deploy:
    desc: Deploy cloudformation template
    deps: [package]
    cmds:
      - sam deploy --s3-bucket {{.S3_BUCKET}} --template-file packaged.yaml --capabilities CAPABILITY_IAM --stack-name {{.STACK_NAME}}

  logtail:
    cmds:
      - sam logs -n {{.LAMBDA}} --stack-name {{.STACK_NAME}} --tail

  local-api:
    desc: Run local API
    cmds:
      - sam local start-api --template {{.TEMPLATE}}
    env:
      TABLE_NAME: aws-sam-ws-python-stack-HelloTable-1DT9ELGRNJQGX
  

  load-test:
    desc: load test the API
    cmds:
    - locust -f loadtest/locustfile.py --host={{.API_URL}} --port 8080